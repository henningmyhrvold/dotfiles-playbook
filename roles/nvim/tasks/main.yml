---
# Neovim Role - Self-contained tasks
# Installs Neovim, LazyVim, and Python provider

# =============================================================================
# Package Installation
# =============================================================================
- name: Install Neovim packages from pacman
  community.general.pacman:
    name: "{{ nvim_pacman_packages }}"
    state: present
  become: true
  tags: ["nvim", "packages"]

# =============================================================================
# Directory Setup
# =============================================================================
- name: Create Neovim directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: "{{ nvim_user }}"
    group: "{{ nvim_user }}"
    mode: "0755"
  loop: "{{ nvim_folders }}"
  become: true
  become_user: "{{ nvim_user }}"
  tags: ["nvim", "folders"]

# =============================================================================
# LazyVim Installation
# =============================================================================
- name: Check if ~/.config/nvim exists
  ansible.builtin.stat:
    path: "{{ nvim_home }}/.config/nvim/init.lua"
  register: nvim_config
  become: true
  become_user: "{{ nvim_user }}"
  tags: ["nvim", "lazyvim"]

- name: Install LazyVim Neovim Setup
  ansible.builtin.git:
    repo: "{{ nvim_lazyvim_repo }}"
    dest: "{{ nvim_home }}/.config/nvim"
    version: "{{ nvim_lazyvim_version }}"
    force: false
  become: true
  become_user: "{{ nvim_user }}"
  when:
    - not nvim_config.stat.exists
    - not (nvim_use_custom_config | default(false))
  tags: ["nvim", "lazyvim"]

# =============================================================================
# Python Virtual Environment for Neovim
# =============================================================================
- name: Create Neovim Python venv if missing
  ansible.builtin.command: "python -m venv {{ nvim_venv_path }}"
  args:
    creates: "{{ nvim_venv_path }}/bin/python"
  become: true
  become_user: "{{ nvim_user }}"
  tags: ["nvim", "venv"]

- name: Ensure pip is present in the venv
  ansible.builtin.command: "{{ nvim_venv_path }}/bin/python -m ensurepip --upgrade"
  args:
    creates: "{{ nvim_venv_path }}/bin/pip"
  become: true
  become_user: "{{ nvim_user }}"
  tags: ["nvim", "venv"]

- name: Upgrade pip and install pynvim + debugpy in the venv
  ansible.builtin.pip:
    name: "{{ nvim_venv_packages }}"
    state: latest
    virtualenv: "{{ nvim_venv_path }}"
    virtualenv_command: "python -m venv"
  become: true
  become_user: "{{ nvim_user }}"
  tags: ["nvim", "venv"]

# =============================================================================
# Custom Config Symlinks
# =============================================================================
- name: Clone dotfiles repository for Neovim configs
  ansible.builtin.git:
    repo: "{{ nvim_dotfiles_repo }}"
    dest: "{{ nvim_dotfiles_dest }}"
    force: false
    update: false
  become: true
  become_user: "{{ nvim_user }}"
  when: nvim_use_custom_config | default(false)
  ignore_errors: true
  tags: ["nvim", "dotfiles"]

- name: Remove existing nvim config directory for custom config
  ansible.builtin.file:
    path: "{{ nvim_home }}/.config/nvim"
    state: absent
  become: true
  become_user: "{{ nvim_user }}"
  when: nvim_use_custom_config | default(false)
  tags: ["nvim", "dotfiles"]

- name: Create Neovim config symlinks
  ansible.builtin.file:
    src: "{{ nvim_dotfiles_dest }}/{{ item.src }}"
    dest: "{{ nvim_home }}/{{ item.dest }}"
    state: link
    force: true
    owner: "{{ nvim_user }}"
  loop: "{{ nvim_links }}"
  become: true
  become_user: "{{ nvim_user }}"
  when: nvim_use_custom_config | default(false)
  tags: ["nvim", "symlinks"]
