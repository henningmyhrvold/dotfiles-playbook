---
# tasks/main.yml for mcp_obsidian role

- name: Ensure Obsidian vault path exists
  ansible.builtin.file:
    path: "{{ mcp_obsidian_vault_path }}"
    state: directory
    mode: "0755"
  become: true
  become_user: "{{ mcp_owner }}"

- name: Ensure MCP obsidian directory exists
  ansible.builtin.file:
    path: "{{ mcp_obsidian_dir }}"
    state: directory
    mode: "0755"
  become: true
  become_user: "{{ mcp_owner }}"

- name: Create Docker network for MCP servers
  community.docker.docker_network:
    name: "{{ mcp_docker_network }}"
    state: present
  become: true

- name: Deploy Docker Compose file for obsidian MCP
  ansible.builtin.template:
    src: docker-compose.mcp-obsidian.yml.j2
    dest: "{{ mcp_obsidian_dir }}/docker-compose.mcp-obsidian.yml"
    mode: "0644"
  become: true
  become_user: "{{ mcp_owner }}"
  notify: restart mcp obsidian

- name: Ensure obsidian MCP service is running
  community.docker.docker_compose_v2:
    project_src: "{{ mcp_obsidian_dir }}"
    files:
      - docker-compose.mcp-obsidian.yml
    state: present
    pull: "{{ mcp_compose_pull_policy }}"
  become: true
  become_user: "{{ mcp_owner }}"

- name: Enable lingering for {{ mcp_owner }}
  ansible.builtin.command: "loginctl enable-linger {{ mcp_owner }}"
  when: mcp_enable_lingering | bool
  changed_when: false
  failed_when: false
  become: true

- name: Ensure systemd user directory exists
  ansible.builtin.file:
    path: "~/.config/systemd/user"
    state: directory
    mode: "0755"
  become: true
  become_user: "{{ mcp_owner }}"

- name: Install systemd user service for obsidian MCP
  ansible.builtin.template:
    src: mcp-obsidian.service.j2
    dest: "~/.config/systemd/user/{{ mcp_obsidian_service_name }}"
    mode: "0644"
  become: true
  become_user: "{{ mcp_owner }}"
  notify: reload systemd user

- name: Enable and start obsidian MCP service
  ansible.builtin.systemd:
    name: "{{ mcp_obsidian_service_name }}"
    scope: user
    enabled: yes
    daemon_reload: yes
    state: started
  become: true
  become_user: "{{ mcp_owner }}"

- name: Register obsidian MCP server for claude_code
  ansible.builtin.set_fact:
    mcp_servers_registered: "{{ mcp_servers_registered | default([]) + [mcp_obsidian_info] }}"
  vars:
    mcp_obsidian_info:
      name: "obsidian"
      type: "stdio"
      command: "docker"
      args:
        - "exec"
        - "-i"
        - "{{ mcp_obsidian_container_name }}"
        - "npx"
        - "{{ mcp_obsidian_npm_package }}"
        - "/vault"
      env: {}
  delegate_to: localhost
  delegate_facts: true
