---
# Pacman Role - Core package manager setup
# This role handles mirrorlist and installs additional packages from config.yml

- name: Install reflector for mirrorlist management
  ansible.builtin.pacman:
    name: reflector
    state: present
  become: true
  tags: ['pacman', 'packages']

- name: Ensure mirrorlist is not empty
  ansible.builtin.stat:
    path: /etc/pacman.d/mirrorlist
  register: mirrorlist_stat
  tags: ['pacman']

- name: Populate mirrorlist if empty or missing
  ansible.builtin.command:
    cmd: reflector --country Norway,Sweden,Germany --latest 10 --protocol https --sort rate --save /etc/pacman.d/mirrorlist
  become: true
  when: mirrorlist_stat.stat.size is not defined or mirrorlist_stat.stat.size < 100
  tags: ['pacman']

- name: Update package cache
  community.general.pacman:
    update_cache: true
  become: true
  tags: ['pacman']

- name: Install packages from pacman_installed_packages list
  community.general.pacman:
    name: "{{ pacman_installed_packages }}"
    state: present
  become: true
  when: pacman_installed_packages is defined
  tags: ['pacman', 'packages']
