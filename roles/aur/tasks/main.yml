# tasks/arch/aur.yml
---
- name: Build paru package (no install or dep sync)
  ansible.builtin.shell:
    cmd: "makepkg --noconfirm"
    chdir: "/home/{{ target_user }}/src/external/paru-git"
  become: true
  become_user: "{{ target_user }}"
  environment:
    PATH: "{{ ansible_env.PATH }}:/home/{{ target_user }}/.cargo/bin"
  args:
    creates: "/home/{{ target_user }}/src/external/paru-git/paru-git*.pkg.tar.zst"
  tags: ['aur']

- name: Find built paru package
  find:
    paths: "/home/{{ target_user }}/src/external/paru-git"
    patterns: "*.pkg.tar.zst"
  register: paru_package

- name: Install paru package as root
  command: "pacman -U --noconfirm {{ paru_package.files[0].path }}"
  args:
    creates: /usr/bin/paru

- name: AUR - Install packages from aur_installed_packages list
  kewlfft.aur.aur:
    name: "{{ item }}"
    use: paru
    state: present
  with_items: "{{ aur_installed_packages }}"
  become: true
  become_user: "{{ target_user }}"
  when: aur_installed_packages is defined
  tags: ['aur']
  
- name: AUR - Update all packages
  ansible.builtin.shell:
    cmd: "paru -Syu --noconfirm"
  become: true
  become_user: "{{ target_user }}"
  tags: ['aur']
