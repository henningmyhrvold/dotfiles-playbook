---
# Claude Desktop Wayland Role - Self-contained tasks
# Installs Claude Desktop with Wayland support

# =============================================================================
# Package Installation
# =============================================================================
- name: Check if paru is installed (for AUR)
  ansible.builtin.command: which paru
  register: paru_check
  changed_when: false
  failed_when: false
  tags: ["claude-desktop", "packages"]

- name: Install Claude Desktop from AUR
  kewlfft.aur.aur:
    name: "{{ item }}"
    use: paru
    state: present
  loop: "{{ claude_desktop_aur_packages }}"
  become: true
  become_user: "{{ claude_desktop_user }}"
  when: paru_check.rc == 0
  tags: ["claude-desktop", "packages"]

# =============================================================================
# Directory Setup
# =============================================================================
- name: Create Claude Desktop directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: "{{ claude_desktop_user }}"
    group: "{{ claude_desktop_user }}"
    mode: "0755"
  loop: "{{ claude_desktop_folders }}"
  become: true
  become_user: "{{ claude_desktop_user }}"
  tags: ["claude-desktop", "folders"]

- name: Ensure user applications directory exists
  ansible.builtin.file:
    path: "{{ claude_desktop_home }}/.local/share/applications"
    state: directory
    owner: "{{ claude_desktop_user }}"
    group: "{{ claude_desktop_user }}"
    mode: "0755"
  become: true
  become_user: "{{ claude_desktop_user }}"
  tags: ["claude-desktop", "folders"]

# =============================================================================
# Wayland Desktop Entry
# =============================================================================
- name: Check if system desktop file exists
  ansible.builtin.stat:
    path: "{{ claude_desktop_system_desktop_file }}"
  register: _system_desktop
  tags: ["claude-desktop", "wayland"]

- name: Read system desktop file
  ansible.builtin.slurp:
    path: "{{ claude_desktop_system_desktop_file }}"
  register: _desktop_content
  when: _system_desktop.stat.exists
  become: true
  tags: ["claude-desktop", "wayland"]

- name: Create Wayland-enabled desktop entry
  ansible.builtin.copy:
    dest: "{{ claude_desktop_user_desktop_file }}"
    content: |
      {{ _desktop_content.content | b64decode | regex_replace('Exec=claude-desktop', 'Exec=claude-desktop ' + claude_desktop_wayland_flags | join(' ')) }}
    owner: "{{ claude_desktop_user }}"
    group: "{{ claude_desktop_user }}"
    mode: "0644"
  become: true
  become_user: "{{ claude_desktop_user }}"
  when:
    - _system_desktop.stat.exists
    - claude_desktop_wayland_enabled | bool
  tags: ["claude-desktop", "wayland"]

# =============================================================================
# NPM for MCP
# =============================================================================
- name: Install npm if not present (for MCP filesystem)
  community.general.pacman:
    name: npm
    state: present
  become: true
  tags: ["claude-desktop", "mcp"]

- name: Verify npx is in PATH
  ansible.builtin.command: which npx
  register: npx_check
  changed_when: false
  failed_when: false
  become: true
  become_user: "{{ claude_desktop_user }}"
  tags: ["claude-desktop", "mcp"]

# =============================================================================
# MCP Filesystem Configuration
# =============================================================================
- name: Check for existing Claude config
  ansible.builtin.stat:
    path: "{{ claude_desktop_config_dir }}/claude_desktop_config.json"
  register: _claude_config
  become: true
  become_user: "{{ claude_desktop_user }}"
  tags: ["claude-desktop", "mcp"]

- name: Read existing Claude config
  ansible.builtin.slurp:
    path: "{{ claude_desktop_config_dir }}/claude_desktop_config.json"
  register: _existing_config
  when: _claude_config.stat.exists
  become: true
  become_user: "{{ claude_desktop_user }}"
  tags: ["claude-desktop", "mcp"]

- name: Parse existing config (handle invalid JSON)
  ansible.builtin.set_fact:
    _current_config: "{{ _existing_config.content | b64decode | from_json }}"
  when:
    - _claude_config.stat.exists
    - _existing_config.content is defined
  ignore_errors: true
  register: _parse_result
  tags: ["claude-desktop", "mcp"]

- name: Create MCP filesystem config
  ansible.builtin.set_fact:
    _mcp_config:
      mcpServers:
        filesystem:
          command: npx
          args: "{{ ['-y', filesystem_server_package] + filesystem_allowed_directories }}"
  tags: ["claude-desktop", "mcp"]

- name: Merge MCP config with existing
  ansible.builtin.set_fact:
    _final_config: "{{ (_current_config | default({})) | combine(_mcp_config, recursive=True) }}"
  tags: ["claude-desktop", "mcp"]

- name: Write Claude Desktop config with MCP
  ansible.builtin.copy:
    dest: "{{ claude_desktop_config_dir }}/claude_desktop_config.json"
    content: "{{ _final_config | to_nice_json }}"
    owner: "{{ claude_desktop_user }}"
    group: "{{ claude_desktop_user }}"
    mode: "0600"
  become: true
  become_user: "{{ claude_desktop_user }}"
  tags: ["claude-desktop", "mcp"]

# =============================================================================
# Summary
# =============================================================================
- name: Display Claude Desktop setup summary
  ansible.builtin.debug:
    msg: |
      Claude Desktop setup complete!

      Wayland: {{ 'Enabled' if claude_desktop_wayland_enabled else 'Disabled' }}
      Config: {{ claude_desktop_config_dir }}/claude_desktop_config.json

      MCP Filesystem allowed directories:
      {% for dir in filesystem_allowed_directories %}
        - {{ dir }}
      {% endfor %}

      To launch: Use the application menu or run 'claude-desktop'
  tags: ["claude-desktop"]
