---
# ACPI Role - Self-contained tasks
# Installs acpid and configures power management

# =============================================================================
# Package Installation
# =============================================================================
- name: Install ACPI packages from pacman
  community.general.pacman:
    name: "{{ acpi_pacman_packages }}"
    state: present
  become: true
  tags: ["acpi", "packages"]

# =============================================================================
# Service Configuration
# =============================================================================
- name: Ensure acpid is enabled and running
  ansible.builtin.systemd:
    name: "{{ acpi_service_name }}"
    state: started
    enabled: "{{ acpi_service_enabled }}"
  become: true
  tags: ["acpi", "services"]

# =============================================================================
# Custom ACPI Handler
# =============================================================================
- name: Deploy custom ACPI handler script
  ansible.builtin.copy:
    dest: /etc/acpi/handler.sh
    mode: "0755"
    owner: root
    group: root
    content: |
      #!/bin/bash
      # Default acpi script that takes an entry for all actions
      case "$1" in
          button/power)
              case "$2" in
                  PBTN|PWRF)
                      logger 'PowerButton pressed'
                      ;;
                  *)
                      logger "ACPI action undefined: $2"
                      ;;
              esac
              ;;
          button/sleep)
              case "$2" in
                  SLPB|SBTN)
                      logger 'SleepButton pressed'
                      ;;
                  *)
                      logger "ACPI action undefined: $2"
                      ;;
              esac
              ;;
          ac_adapter)
              case "$2" in
                  AC|ACAD|ADP0)
                      case "$4" in
                          00000000)
                              logger 'AC unplugged'
                              ;;
                          00000001)
                              logger 'AC plugged'
                              ;;
                      esac
                      ;;
                  *)
                      logger "ACPI action undefined: $2"
                      ;;
              esac
              ;;
          battery)
              case "$2" in
                  BAT0)
                      case "$4" in
                          00000000)
                              logger 'Battery offline'
                              ;;
                          00000001)
                              logger 'Battery online'
                              ;;
                      esac
                      ;;
                  CPU0)
                      ;;
                  *)
                      logger "ACPI action undefined: $2"
                      ;;
              esac
              ;;
          button/lid)
              case "$3" in
                  close)
                      logger 'Lid closed'
                      ;;
                  open)
                      logger 'Lid opened'
                      ;;
                  *)
                      logger "ACPI action undefined: $3"
                      ;;
              esac
              ;;
          *)
              logger "ACPI group/action undefined: $1 / $2"
              ;;
      esac
  become: true
  tags: ["acpi", "handler"]
